import admin from 'firebase-admin';
import fs from 'fs';
import path from 'path';
import { v4 as uuidv4 } from 'uuid';
import readline from 'readline';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Interface para input do usu√°rio
const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout
});

/**
 * Solicita input do usu√°rio
 */
function askQuestion(question) {
  return new Promise((resolve) => {
    rl.question(question, (answer) => {
      resolve(answer);
    });
  });
}

/**
 * Inicializa o Firebase Admin SDK
 */
async function initializeFirebase() {
  try {
    // Verifica se j√° existe uma app inicializada
    if (admin.apps.length === 0) {
      console.log('üîß Inicializando Firebase Admin SDK...');
      
      // Tenta usar vari√°veis de ambiente primeiro
      const serviceAccountJson = process.env.FIREBASE_SERVICE_ACCOUNT_JSON || process.env.FIREBASE_SERVICE_ACCOUNT_KEY;
      
      if (serviceAccountJson) {
        console.log('üîë Usando credenciais das vari√°veis de ambiente...');
        
        try {
          // Remove poss√≠veis caracteres de quebra de linha ou espa√ßos extras
          let cleanServiceAccountKey = serviceAccountJson.trim();
          
          // Se come√ßar com aspas, remove elas (pode acontecer quando o JSON √© colado como string)
          if (cleanServiceAccountKey.startsWith('"') && cleanServiceAccountKey.endsWith('"')) {
            cleanServiceAccountKey = cleanServiceAccountKey.slice(1, -1);
          }
          
          // Substitui escape de aspas por aspas normais
          cleanServiceAccountKey = cleanServiceAccountKey.replace(/\\"/g, '"');
          
          // Substitui escape de quebras de linha e outros caracteres especiais
          cleanServiceAccountKey = cleanServiceAccountKey.replace(/\\n/g, '\\n');
          cleanServiceAccountKey = cleanServiceAccountKey.replace(/\\r/g, '');
          cleanServiceAccountKey = cleanServiceAccountKey.replace(/\\t/g, '');
          
          // Remove caracteres de controle problem√°ticos
          cleanServiceAccountKey = cleanServiceAccountKey.replace(/[\x00-\x1F\x7F]/g, '');
          
          console.log('üîç Verificando formato das credenciais...');
          
          const serviceAccount = JSON.parse(cleanServiceAccountKey);
          
          if (!serviceAccount.project_id) {
            throw new Error('project_id n√£o encontrado nas credenciais');
          }
          
          if (!serviceAccount.type || serviceAccount.type !== 'service_account') {
            throw new Error('Tipo de credencial inv√°lido. Deve ser "service_account"');
          }
          
          admin.initializeApp({
            credential: admin.credential.cert(serviceAccount),
            storageBucket: `${serviceAccount.project_id}.appspot.com`
          });
          
          console.log('‚úÖ Firebase Admin SDK inicializado com credenciais de ambiente!');
          console.log(`üìÅ Projeto: ${serviceAccount.project_id}`);
        } catch (parseError) {
          console.error('‚ùå Erro ao fazer parse das credenciais de ambiente:', parseError.message);
          console.error('üîç Verifique se o JSON das credenciais est√° v√°lido e completo.');
          console.error('üìã Dica: O JSON deve come√ßar com { e terminar com }');
          console.error('üîß As credenciais devem ser o conte√∫do completo do arquivo serviceAccountKey.json');
          process.exit(1);
        }
      } else {
        // Fallback para arquivo local
        const serviceAccountPath = path.join(__dirname, 'serviceAccountKey.json');
        
        if (!fs.existsSync(serviceAccountPath)) {
          console.log('‚ùå Nenhuma credencial Firebase encontrada.');
          console.log('üìÅ Vari√°vel FIREBASE_SERVICE_ACCOUNT_KEY n√£o definida e arquivo serviceAccountKey.json n√£o encontrado.');
          console.log('üîß Configure a vari√°vel de ambiente FIREBASE_SERVICE_ACCOUNT_KEY com o conte√∫do do arquivo JSON.');
          process.exit(1);
        }
        
        console.log('üìÅ Usando arquivo serviceAccountKey.json local...');
        const serviceAccount = JSON.parse(fs.readFileSync(serviceAccountPath, 'utf8'));
        
        admin.initializeApp({
          credential: admin.credential.cert(serviceAccount),
          storageBucket: `${serviceAccount.project_id}.appspot.com`
        });
        
        console.log('‚úÖ Firebase Admin SDK inicializado com arquivo local!');
      }
    }
    
    // Tenta diferentes varia√ß√µes do bucket
    const possibleBuckets = [
      `${admin.app().options.storageBucket}`,
      'app-teatrinho.firebasestorage.app',
      'app-teatrinho.appspot.com',
      `${admin.app().options.projectId}.appspot.com`,
      `${admin.app().options.projectId}.firebasestorage.app`,
      `gs://app-teatrinho.firebasestorage.app`,
      `gs://${admin.app().options.projectId}.appspot.com`,
      `gs://${admin.app().options.projectId}.firebasestorage.app`
    ];
    
    console.log('ü™£ Testando buckets dispon√≠veis...');
    
    for (const bucketName of possibleBuckets) {
      try {
        console.log(`üîç Testando bucket: ${bucketName}`);
        const bucket = admin.storage().bucket(bucketName);
        await bucket.getMetadata();
        console.log(`‚úÖ Bucket encontrado: ${bucketName}`);
        return bucket;
      } catch (error) {
        console.log(`‚ùå Bucket ${bucketName} n√£o acess√≠vel: ${error.message}`);
      }
    }
    
    // Se nenhum bucket funcionou, cria arquivo de exemplo
    console.log('‚ö†Ô∏è  Nenhum bucket de Storage encontrado.');
    console.log('üìã Para usar este script voc√™ precisa:');
    console.log('   1. Ativar o Firebase Storage no Console');
    console.log('   2. Criar uma pasta "atividades/" no Storage');
    console.log('   3. Organizar as imagens em subpastas por categoria');
    console.log('   4. Fazer upload dos arquivos .jpg');
    console.log('');
    console.log('üîß Estrutura esperada no Storage:');
    console.log('   atividades/');
    console.log('   ‚îú‚îÄ‚îÄ pre-escrita-tracado/');
    console.log('   ‚îÇ   ‚îú‚îÄ‚îÄ 1.jpg');
    console.log('   ‚îÇ   ‚îú‚îÄ‚îÄ 2.jpg');
    console.log('   ‚îÇ   ‚îî‚îÄ‚îÄ ...');
    console.log('   ‚îú‚îÄ‚îÄ coordenacao-motora/');
    console.log('   ‚îÇ   ‚îú‚îÄ‚îÄ 1.jpg');
    console.log('   ‚îÇ   ‚îî‚îÄ‚îÄ ...');
    console.log('   ‚îî‚îÄ‚îÄ matematica-basica/');
    console.log('       ‚îî‚îÄ‚îÄ ...');
    console.log('');
    console.log('üìÑ Criando arquivo de exemplo com dados fict√≠cios...');
    
    // Gera dados de exemplo
    const atividadesExemplo = criarDadosExemplo();
    return { isExample: true, atividades: atividadesExemplo };
  } catch (error) {
    console.error('‚ùå Erro ao inicializar Firebase:', error.message);
    process.exit(1);
  }
}

/**
 * Cria dados de exemplo para demonstra√ß√£o
 */
function criarDadosExemplo() {
  const categorias = ['pre-escrita-tracado', 'coordenacao-motora', 'matematica-basica', 'formas-geometricas', 'alfabetizacao'];
  const atividades = [];
  
  categorias.forEach(categoria => {
    for (let i = 1; i <= 3; i++) {
      atividades.push({
        id: uuidv4(),
        ordem: i,
        data: new Date().toISOString(),
        categoria: categoria,
        pasta: `atividades/${categoria}`,
        arquivo: `${i}.jpg`,
        imagemUrl: `https://firebasestorage.googleapis.com/exemplo/atividades/${categoria}/${i}.jpg`
      });
    }
  });
  
  return atividades;
}

/**
 * Percorre as pastas no Storage e identifica arquivos .jpg
 */
async function percorrerAtividades(bucket) {
  // Se for um bucket de exemplo, retorna os dados de exemplo
  if (bucket.isExample) {
    return bucket;
  }
  
  console.log('üìÅ Percorrendo estrutura de pastas no Firebase Storage...');
  
  try {
    // Lista todos os arquivos na pasta atividades/
    const [files] = await bucket.getFiles({ prefix: 'atividades/' });
    
    const atividades = [];
    const categorias = new Set();
    
    for (const file of files) {
      const filePath = file.name;
      
      // Ignora se n√£o √© arquivo .jpg
      if (!filePath.endsWith('.jpg')) {
        continue;
      }
      
      // Extrai informa√ß√µes do caminho: atividades/categoria/arquivo.jpg
      const pathParts = filePath.split('/');
      
      if (pathParts.length < 3) {
        console.log(`‚ö†Ô∏è  Caminho inv√°lido ignorado: ${filePath}`);
        continue;
      }
      
      const categoria = pathParts[1];
      const nomeArquivo = pathParts[2];
      const ordem = parseInt(path.basename(nomeArquivo, '.jpg')) || 1;
      
      categorias.add(categoria);
      
      // Gera URL p√∫blica para a imagem
      const [url] = await file.getSignedUrl({
        action: 'read',
        expires: '03-01-2030' // URL v√°lida por muito tempo
      });
      
      // Cria objeto da atividade
      const atividade = {
        id: uuidv4(),
        ordem: ordem,
        data: new Date().toISOString(),
        categoria: categoria,
        pasta: `atividades/${categoria}`,
        arquivo: nomeArquivo,
        imagemUrl: url
      };
      
      atividades.push(atividade);
    }
    
    // Ordena atividades por categoria e depois por ordem
    atividades.sort((a, b) => {
      if (a.categoria !== b.categoria) {
        return a.categoria.localeCompare(b.categoria);
      }
      return a.ordem - b.ordem;
    });
    
    return {
      atividades,
      totalCategorias: categorias.size,
      totalAtividades: atividades.length
    };
    
  } catch (error) {
    console.error('‚ùå Erro ao percorrer atividades:', error.message);
    throw error;
  }
}

/**
 * Salva o arquivo atividades.json
 */
function salvarArquivoJSON(atividades) {
  console.log('üíæ Salvando arquivo atividades.json...');
  
  try {
    // Cria diret√≥rio se n√£o existir
    const outputDir = path.join(__dirname, '../client/src/data');
    if (!fs.existsSync(outputDir)) {
      fs.mkdirSync(outputDir, { recursive: true });
    }
    
    // Salva o arquivo JSON
    const outputPath = path.join(outputDir, 'atividades.json');
    fs.writeFileSync(outputPath, JSON.stringify(atividades, null, 2), 'utf8');
    
    console.log(`‚úÖ Arquivo salvo em: ${outputPath}`);
    return outputPath;
    
  } catch (error) {
    console.error('‚ùå Erro ao salvar arquivo:', error.message);
    throw error;
  }
}

/**
 * Fun√ß√£o principal
 */
async function main() {
  console.log('üöÄ Iniciando gera√ß√£o do arquivo atividades.json...\n');
  
  try {
    // Inicializa Firebase
    const bucket = await initializeFirebase();
    
    // Percorre atividades no Storage
    const resultado = await percorrerAtividades(bucket);
    
    let outputPath, resumo;
    
    if (resultado.isExample) {
      // Salva arquivo de exemplo
      outputPath = salvarArquivoJSON(resultado.atividades);
      const categorias = new Set(resultado.atividades.map(a => a.categoria));
      
      resumo = {
        totalCategorias: categorias.size,
        totalAtividades: resultado.atividades.length,
        isExample: true
      };
    } else {
      // Salva dados reais do Storage
      outputPath = salvarArquivoJSON(resultado.atividades);
      resumo = resultado;
    }
    
    // Exibe resumo
    console.log('\nüìä RESUMO DA EXECU√á√ÉO:');
    if (resumo.isExample) {
      console.log('‚ö†Ô∏è  Dados de exemplo gerados (Storage n√£o configurado)');
    }
    console.log(`üìÅ Total de categorias: ${resumo.totalCategorias}`);
    console.log(`üìÑ Total de atividades: ${resumo.totalAtividades}`);
    console.log(`üíæ Arquivo salvo em: ${outputPath}`);
    
    if (resumo.isExample) {
      console.log('\nüîß Para usar dados reais do Firebase Storage:');
      console.log('   1. Configure o Firebase Storage no projeto');
      console.log('   2. Fa√ßa upload das atividades na estrutura de pastas');
      console.log('   3. Execute o script novamente');
    }
    
    console.log('\n‚úÖ Processo conclu√≠do com sucesso!');
    
  } catch (error) {
    console.error('\n‚ùå Erro durante a execu√ß√£o:', error.message);
    process.exit(1);
  } finally {
    rl.close();
  }
}

// Executa o script
if (import.meta.url === `file://${process.argv[1]}`) {
  main();
}